{"version":3,"file":"GpuBufferSystem.js","sources":["../../../../../src/rendering/renderers/gpu/buffer/GpuBufferSystem.ts"],"sourcesContent":["import { ExtensionType } from '../../../../extensions/Extensions';\nimport { type GPUData } from '../../../../scene/view/ViewContainer';\nimport { GCManagedHash } from '../../../../utils/data/GCManagedHash';\nimport { uid } from '../../../../utils/data/uid';\nimport { fastCopy } from '../../shared/buffer/utils/fastCopy';\n\nimport type { Buffer } from '../../shared/buffer/Buffer';\nimport type { System } from '../../shared/system/System';\nimport type { GPU } from '../GpuDeviceSystem';\nimport type { WebGPURenderer } from '../WebGPURenderer';\n\n/** @internal */\nexport class GpuBufferData implements GPUData\n{\n    public gpuBuffer: GPUBuffer;\n\n    constructor(gpuBuffer: GPUBuffer)\n    {\n        this.gpuBuffer = gpuBuffer;\n    }\n\n    public destroy()\n    {\n        this.gpuBuffer.destroy();\n        this.gpuBuffer = null;\n    }\n}\n\n/**\n * System plugin to the renderer to manage buffers.\n * @category rendering\n * @advanced\n */\nexport class GpuBufferSystem implements System\n{\n    /** @ignore */\n    public static extension = {\n        type: [\n            ExtensionType.WebGPUSystem,\n        ],\n        name: 'buffer',\n    } as const;\n\n    protected CONTEXT_UID: number;\n    private readonly _renderer: WebGPURenderer;\n    private readonly _managedBuffers: GCManagedHash<Buffer>;\n\n    private _gpu: GPU;\n\n    constructor(renderer: WebGPURenderer)\n    {\n        this._renderer = renderer;\n        this._managedBuffers = new GCManagedHash({\n            renderer,\n            type: 'resource',\n            onUnload: this.onBufferUnload.bind(this),\n            name: 'gpuBuffer'\n        });\n    }\n\n    protected contextChange(gpu: GPU): void\n    {\n        this._gpu = gpu;\n    }\n\n    public getGPUBuffer(buffer: Buffer): GPUBuffer\n    {\n        buffer._gcLastUsed = this._renderer.gc.now;\n\n        return (buffer._gpuData[this._renderer.uid] as GpuBufferData)?.gpuBuffer || this.createGPUBuffer(buffer);\n    }\n\n    public updateBuffer(buffer: Buffer): GPUBuffer\n    {\n        const gpuBuffer = this.getGPUBuffer(buffer);\n\n        const data = buffer.data;\n\n        // TODO this can be better...\n        if (buffer._updateID && data)\n        {\n            buffer._updateID = 0;\n\n            // make sure\n            this._gpu.device.queue.writeBuffer(\n                gpuBuffer, 0, data.buffer, 0,\n                // round to the nearest 4 bytes\n                ((buffer._updateSize || data.byteLength) + 3) & ~3\n            );\n        }\n\n        return gpuBuffer;\n    }\n\n    /** dispose all WebGL resources of all managed buffers */\n    public destroyAll(): void\n    {\n        this._managedBuffers.removeAll();\n    }\n\n    protected onBufferUnload(buffer: Buffer): void\n    {\n        buffer.off('update', this.updateBuffer, this);\n        buffer.off('change', this.onBufferChange, this);\n    }\n\n    public createGPUBuffer(buffer: Buffer): GPUBuffer\n    {\n        const gpuBuffer = this._gpu.device.createBuffer(buffer.descriptor);\n\n        buffer._updateID = 0;\n        buffer._resourceId = uid('resource');\n\n        if (buffer.data)\n        {\n            // TODO if data is static, this can be mapped at creation\n            fastCopy(buffer.data.buffer, gpuBuffer.getMappedRange());\n\n            gpuBuffer.unmap();\n        }\n\n        buffer._gpuData[this._renderer.uid] = new GpuBufferData(gpuBuffer);\n        if (this._managedBuffers.add(buffer))\n        {\n            buffer.on('update', this.updateBuffer, this);\n            buffer.on('change', this.onBufferChange, this);\n        }\n\n        return gpuBuffer;\n    }\n\n    protected onBufferChange(buffer: Buffer)\n    {\n        this._managedBuffers.remove(buffer);\n        buffer._updateID = 0;\n        this.createGPUBuffer(buffer);\n    }\n\n    public destroy(): void\n    {\n        this._managedBuffers.destroy();\n        (this._renderer as null) = null;\n        this._gpu = null;\n    }\n}\n\n"],"names":["GCManagedHash","uid","fastCopy","ExtensionType"],"mappings":"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"}