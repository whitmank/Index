# Development Log - Electron Integration
**Date:** January 14, 2026
**Session Duration:** ~2 hours
**Focus:** Electron desktop app integration for Index project

---

## Overview

Successfully integrated Electron to transform the Index web application into a standalone desktop app for macOS, Windows, and Linux. Implemented a hybrid architecture that maintains the existing REST API while adding native filesystem capabilities through IPC.

---

## Architecture Decisions

### Hybrid HTTP + IPC Approach
- **HTTP/REST:** All database operations continue using existing Express API
  - Minimal changes to frontend code
  - Maintains web compatibility
  - Easy to debug with browser DevTools
- **IPC:** Native OS features via Electron's main-renderer communication
  - File/folder picker dialogs
  - Filesystem watching (chokidar)
  - System metadata access

### Embedded Service Mode
- Electron main process manages Express + SurrealDB lifecycle
- Detects if services already running (dev mode compatibility)
- Dynamic port allocation with conflict detection
- Graceful shutdown handling

### Bundled Binaries
- Production builds include platform-specific SurrealDB binaries
- Development mode uses system-installed binary
- Documentation provided for downloading binaries

---

## New Directory Structure

```
electron/
├── main/
│   ├── index.js                    # App entry point & lifecycle
│   ├── services/
│   │   ├── database-manager.js     # Express + SurrealDB orchestration
│   │   ├── port-manager.js         # Dynamic port allocation
│   │   └── path-resolver.js        # Dev vs prod path resolution
│   ├── ipc/
│   │   ├── handlers.js             # IPC request handlers
│   │   └── channels.js             # IPC channel constants
│   └── window/
│       └── create-window.js        # (future) Window factory
├── preload/
│   └── index.js                    # Security boundary (contextBridge)
└── resources/
    ├── README.md                   # Binary download instructions
    ├── mac/                        # macOS binaries (future)
    ├── win/                        # Windows binaries (future)
    └── linux/                      # Linux binaries (future)
```

---

## Files Created

### Electron Core
- `electron/main/index.js` - Main process entry point
- `electron/main/services/database-manager.js` - Backend service orchestration
- `electron/main/services/port-manager.js` - Port conflict detection/resolution
- `electron/main/services/path-resolver.js` - Environment-aware path resolution
- `electron/main/ipc/handlers.js` - IPC handlers for filesystem operations
- `electron/main/ipc/channels.js` - IPC channel name constants
- `electron/preload/index.js` - Secure context bridge for renderer
- `electron/resources/README.md` - Binary download instructions

### Frontend Integration
- `frontend/src/hooks/useElectron.js` - React hook for Electron API access

---

## Files Modified

### Backend
- `backend/database/server.js`
  - Refactored from immediate execution to factory function pattern
  - Accepts dynamic configuration (ports, paths, binary location)
  - Exports `{ start, stop, app, getPort, getDbPort }`
  - Maintains backward compatibility with standalone execution

### Frontend
- `frontend/vite.config.js`
  - Added `base: './'` for Electron production builds
  - Optimized rollup for file:// protocol compatibility
  - Added electron build mode support

- `frontend/src/components/AddFilesModal/AddFilesModal.jsx`
  - Integrated native file/folder picker
  - Added "Browse..." button (Electron-only)
  - Uses `useElectron()` hook for environment detection

- `frontend/src/components/Layout/Layout.css`
  - Briefly attempted custom drag region (reverted)
  - Settled on standard macOS title bar

### Configuration
- `package.json` (root)
  - Added `"main": "electron/main/index.js"`
  - Added `"productName": "Index"`
  - Added Electron development scripts:
    - `electron:dev` - Full stack with Electron
    - `electron:start` - Launch Electron only
  - Added build scripts:
    - `build` - Build frontend + electron
    - `build:frontend` - Build with electron mode
    - `build:electron` - electron-builder
    - `package:mac/win/linux` - Platform-specific packages
  - Added `build` section with electron-builder configuration
  - Added dependencies: electron, electron-builder, electron-reloader, wait-on, chokidar, get-port

---

## Issues Resolved

### 1. Port Manager ES Module Issue
**Problem:** `get-port` v7.x is ESM-only, incompatible with CommonJS `require()`
**Error:** `TypeError: getPort is not a function`
**Solution:** Implemented lazy loading with dynamic `import()` in `port-manager.js`

### 2. Database Lock Conflict
**Problem:** Both standalone database service and Electron tried to start SurrealDB
**Error:** `Resource temporarily unavailable` on database.db/LOCK
**Solution:** Added health check in `database-manager.js` to detect existing services

### 3. DevTools Auto-Opening
**Problem:** DevTools opened by default, cluttering the interface
**Solution:** Removed `mainWindow.webContents.openDevTools()` from dev mode

### 4. Window Drag Region
**Problem:** User wanted standard macOS title bar, not custom drag region
**Solution:** Changed from `titleBarStyle: 'hiddenInset'` to `titleBarStyle: 'default'`

### 5. Application Name in Menu Bar
**Problem:** Menu bar showed "Electron" instead of "Index" in development
**Solution:**
  - Added `app.setName('Index')` before app ready
  - Created custom macOS menu with correct app name
  - Added `"productName": "Index"` to package.json
  - Documented that dev mode will show "Electron" (expected behavior)

---

## Features Implemented

### Native Filesystem Integration
- **File/Folder Picker:** Native OS dialogs via IPC
- **File Watching:** Real-time monitoring with chokidar
- **System Metadata:** Access to OS-specific file attributes (uid, gid, mode)

### Development Experience
- **Auto-Reload:**
  - Frontend: Instant HMR via Vite
  - Main process: Auto-restart with electron-reloader
- **Keyboard Shortcuts:**
  - Cmd/Ctrl+R: Reload renderer
  - Cmd/Ctrl+Shift+I: Toggle DevTools
- **Service Detection:** Automatically uses existing backend services in dev mode

### Application Menu
Custom macOS menu with proper branding:
- Index menu (About, Services, Hide, Quit)
- Edit menu (Undo, Redo, Cut, Copy, Paste, Select All)
- View menu (Reload, Toggle DevTools, Zoom)
- Window menu (Minimize, Zoom, Front)

---

## Development Workflows

### Web Development (unchanged)
```bash
npm run dev
```
- Backend on port 3000
- Frontend on port 5173
- Opens in browser

### Electron Development
```bash
npm run electron:dev
```
- Backend on port 3000 (or next available)
- Frontend on port 5173 (Vite dev server)
- Electron window with native features

### Production Build
```bash
npm run build           # Build frontend + electron
npm run package:mac     # Create macOS .dmg
npm run package:win     # Create Windows installer
npm run package:linux   # Create Linux package
```

---

## Configuration Details

### Path Resolution (dev vs prod)
| Resource | Development | Production |
|----------|-------------|------------|
| Frontend | Vite dev server (http://localhost:5173) | Built files via `loadFile()` |
| Backend | Separate process | Embedded in main process |
| SurrealDB binary | System PATH | Bundled in resources/binaries/ |
| Database path | ./data/database.db | app.getPath('userData')/database.db |
| API ports | 3000/8000 (with fallback) | Dynamic allocation |

### IPC Channels Defined
- `fs:select-directory` - Open directory picker
- `fs:select-file` - Open file picker
- `fs:get-file-metadata` - Get system metadata
- `fs:watch-path` - Start watching path
- `fs:unwatch-path` - Stop watching path
- `fs:file-changed` - Event: file changed
- `fs:directory-changed` - Event: directory changed
- `app:get-path` - Get app path
- `app:get-user-data-path` - Get user data path

---

## Security Implementation

- **Context Isolation:** Enabled in renderer
- **Node Integration:** Disabled in renderer
- **Preload Script:** Uses `contextBridge` to expose only whitelisted APIs
- **Localhost Only:** Backend binds to 127.0.0.1 (no network exposure)
- **Path Validation:** All IPC file paths should be validated

---

## Testing Status

✅ Development mode working
✅ Frontend HMR working
✅ Auto-reload for main process working
✅ Native file picker functional
✅ Service detection working
✅ Port conflict resolution working
✅ Graceful shutdown working
✅ Standard macOS title bar with drag
⏳ Production build (not yet tested)
⏳ Windows build (not yet tested)
⏳ Linux build (not yet tested)

---

## Next Steps

### Immediate
1. Test production builds on all platforms
2. Download and bundle SurrealDB binaries
3. Test filesystem watching integration
4. Implement file change → auto-reindex

### Future Enhancements
- Auto-update support with electron-updater
- System tray integration
- Native notifications
- Menu bar extras
- Keyboard shortcuts customization
- Code signing for distribution
- DMG customization for macOS
- Installer customization for Windows

---

## Dependencies Added

```json
{
  "devDependencies": {
    "electron": "^39.2.7",
    "electron-builder": "^26.4.0",
    "electron-devtools-installer": "^4.0.0",
    "electron-reloader": "^1.2.3",
    "wait-on": "^9.0.3",
    "chokidar": "^5.0.0",
    "get-port": "^7.1.0"
  }
}
```

---

## Technical Notes

### Why Hybrid HTTP + IPC?
- **Pragmatic:** Minimal refactoring of existing codebase
- **Debuggable:** Can still use browser Network tab
- **Flexible:** Can run as web app or desktop app
- **Progressive:** Can migrate more to IPC over time if needed

### Why Not Full IPC?
- Would require replacing ~30+ fetch() calls
- Loses browser DevTools for API debugging
- Tightly couples to Electron (no web deployment)
- More complex error handling
- The HTTP overhead is negligible for local connections

### Production Considerations
- SurrealDB binaries need to be downloaded and placed in resources/
- Code signing recommended for macOS (notarization)
- Consider update server for electron-updater
- Test on all target platforms before release
- Monitor app size (currently ~50MB per platform due to binaries)

---

## Lessons Learned

1. **ES Modules in Electron:** Modern packages like `get-port` require dynamic import
2. **Service Detection:** Always check if services are already running in dev mode
3. **Menu Bar Branding:** Dev mode will show "Electron" - this is expected
4. **Title Bar Styles:** Users often want standard OS window chrome, not custom
5. **Auto-Reload:** Split frontend (Vite) and main process (electron-reloader) for best DX

---

## Session Summary

Successfully transformed Index from a web application into a fully-functional Electron desktop app while maintaining the existing architecture. The hybrid approach provides native filesystem capabilities without major refactoring. Development experience is excellent with instant hot reload and auto-restart. Production builds are configured but not yet tested. All core functionality working in development mode.

**Status:** ✅ Complete and functional in development mode
