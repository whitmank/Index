# Index v0.2 - Final Product Specification

> Reverse-engineered specification documenting the current state of the application.
> Use this as the foundation for building v0.3 from scratch.

---

## 1. Product Overview

**Product Name:** Index

**Type:** Desktop personal information indexing and visualization system

**Problem Statement:** Users need a way to organize, tag, visualize, and query personal files across their filesystem without relying on traditional folder hierarchies.

**Solution:** A local-first desktop application that creates a semantic layer on top of the filesystem with content-based deduplication, flexible tagging, smart collections, and graph visualization.

**Target Platform:** Cross-platform desktop (macOS, Windows, Linux) via Electron

---

## 2. Architecture

### 2.1 High-Level Structure

```
┌─────────────────────────────────────────────────────────┐
│                    Electron Shell                        │
│  ┌─────────────────┐  ┌────────────────────────────────┐│
│  │   Main Process  │  │        Renderer (React)        ││
│  │  - IPC Handlers │  │  - Layout state management     ││
│  │  - File dialogs │  │  - FileListTable component     ││
│  │  - File watching│  │  - DetailPanel                 ││
│  │  - DB Manager   │  │  - Graph visualization         ││
│  └────────┬────────┘  └───────────────┬────────────────┘│
└───────────┼───────────────────────────┼─────────────────┘
            │                           │
            ▼                           ▼
┌───────────────────────┐    ┌─────────────────────────────┐
│   Express API (:3000) │◄───│  SurrealDB (embedded :8000) │
│   - REST endpoints    │    │  - Nodes, Tags, Collections │
│   - File streaming    │    │  - Links, Relationships     │
└───────────────────────┘    └─────────────────────────────┘
```

### 2.2 Directory Structure

```
Index/
├── electron/           # Desktop wrapper
│   ├── main/           # Main process (IPC, services)
│   └── preload/        # Context bridge API
├── frontend/           # React UI (Vite)
│   └── src/
│       ├── components/ # Reusable UI components
│       └── pages/      # Route-based views
├── backend/
│   ├── database/       # Express REST API + SurrealDB
│   ├── fs-indexer/     # File scanning service
│   └── force-sim/      # D3 physics simulation package
└── data/               # Local SurrealDB storage
```

### 2.3 Technology Stack

| Layer | Technology | Version |
|-------|------------|---------|
| Desktop Shell | Electron | 39.2.7 |
| Frontend | React | 19.2.3 |
| Build Tool | Vite | 7.2.4 |
| Routing | React Router | 7.12.0 |
| Backend API | Express | 5.2.1 |
| Database | SurrealDB | 1.3.2 |
| Graph Physics | D3 Force | Custom wrapper |

### 2.4 Port Configuration

| Service | Default Port |
|---------|--------------|
| Frontend (dev) | 5173 |
| Express API | 3000 |
| SurrealDB | 8000 |

---

## 3. Data Model

### 3.1 Nodes (Primary Entity)

Represents indexed files in the system.

```javascript
{
  id: "nodes:ulid",
  content_hash: "sha256:...",      // SHA-256 for deduplication
  name: "file.png",                // Filename
  size: 73264,                     // Bytes
  type: "image/png",               // MIME type
  source_path: "/absolute/path",   // Filesystem location
  timestamp_created: ISO8601,      // File creation time
  timestamp_modified: ISO8601,     // File modification time
  metadata: {
    extension: ".png",
    notes: "user notes...",
    // Extensible custom fields
  }
}
```

### 3.2 Tags (Many-to-One with Nodes)

Labels that can be attached to files.

```javascript
{
  id: "tags:ulid",
  tag_name: "important",
  node_id: "nodes:abc123",
  timestamp_created: ISO8601
}
```

### 3.3 Collections (Smart Folders)

Tag-based views using AND logic.

```javascript
{
  id: "collections:ulid",
  name: "Project Alpha",
  tags: ["tag1", "tag2"],          // Files must have ALL tags
  color: "#4D9FFF",                // Visual identifier
  timestamp_created: ISO8601
}
```

### 3.4 Links (Node Relationships)

Connections between nodes for graph visualization.

```javascript
{
  id: "links:ulid",
  source_node: "nodes:abc",
  target_node: "nodes:xyz",
  type: "semantic|derivative|reference",
  strength: 0.8,                   // 0-1 relationship strength
  timestamp_created: ISO8601,
  timestamp_modified: ISO8601,
  metadata: {}
}
```

---

## 4. Features

### 4.1 File Indexing

**Import Methods:**
1. Native file picker (button click)
2. Paste-to-import (paste file paths)
3. API endpoint (POST /api/index)

**Indexing Process:**
1. User selects files/folders
2. Confirmation modal with optional tags and collection assignment
3. Recursive directory traversal
4. For each file:
   - Extract metadata (name, size, MIME type, timestamps)
   - Calculate SHA-256 content hash
   - Create node via API
5. Apply tags to newly indexed nodes

**Deduplication Strategy:**
- Content hash match → 409 (duplicate by content)
- Path match → 200 (update existing record)
- New file → 201 (created)

**Ignored Files:** .DS_Store, Thumbs.db, system files

### 4.2 Tagging System

- Add/remove tags via detail panel
- Tag autocomplete from existing tags
- Search files by tag name
- Tags page shows all tags with file counts
- Visual tag badges in file list

### 4.3 Collections

**Concept:** Smart folders based on tag queries with AND logic.

**Behavior:**
- Create collection with name + required tags
- Files appear only if they have ALL specified tags
- Pin collections to sidebar for quick access
- Custom colors for visual identification
- Import files directly to collection (auto-applies tags)

**Example:**
```
Collection: "Project Alpha Assets"
Tags: ["alpha", "asset"]
Result: Shows only files tagged with BOTH "alpha" AND "asset"
```

### 4.4 Graph Visualization

**Technology:** D3 force simulation

**Features:**
- Nodes as circles (colored by file type)
- Links as lines between related nodes
- Force-directed auto-layout
- Interactive drag-to-position
- Zoom and pan controls
- Node labels (truncated for long names)

### 4.5 File Browsing

**Views:**
1. All Files - Complete indexed file list
2. Tags - Files grouped by tag
3. Collections - List of collections
4. Collection Detail - Files within specific collection
5. Graph - Visual network
6. Dev - Debug tools

**Selection:**
- Click: Select single
- Cmd/Ctrl+Click: Toggle selection
- Shift+Click: Range selection
- Cmd/Ctrl+A: Select all
- Delete key: Remove selected (with confirmation)

**Detail Panel:**
- File metadata display
- Tag management
- Notes field
- Link creation
- Delete action

### 4.6 Native OS Integration

**IPC Channels:**

| Channel | Direction | Purpose |
|---------|-----------|---------|
| `fs:select-directory` | renderer→main | Folder picker |
| `fs:select-file` | renderer→main | File picker |
| `fs:select-paths` | renderer→main | Multi-select |
| `fs:get-file-metadata` | renderer→main | File stats |
| `fs:watch-path` | renderer→main | Start watching |
| `fs:unwatch-path` | renderer→main | Stop watching |
| `fs:file-changed` | main→renderer | File change event |
| `fs:directory-changed` | main→renderer | Directory change event |

---

## 5. API Endpoints

### 5.1 Health & Status

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/health` | Health check |
| GET | `/api/status` | Server and database status |
| GET | `/api/database` | Current namespace/database |
| POST | `/api/database` | Switch namespace/database |

### 5.2 Nodes

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/nodes` | List all nodes |
| GET | `/api/nodes/:id` | Get single node |
| POST | `/api/nodes` | Create node |
| PUT | `/api/nodes/:id` | Update node |
| DELETE | `/api/nodes/:id` | Delete node |
| GET | `/api/files/:id` | Stream file content |

### 5.3 Tags

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/tags` | List all tags |
| GET | `/api/nodes/:id/tags` | Tags for specific node |
| POST | `/api/tags` | Create tag |
| DELETE | `/api/tags/:id` | Delete tag |

### 5.4 Links

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/links` | List all links |
| POST | `/api/links` | Create link |
| PUT | `/api/links/:id` | Update link |
| DELETE | `/api/links/:id` | Delete link |

### 5.5 Collections

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/collections` | List all collections |
| GET | `/api/collections/:id` | Get collection |
| GET | `/api/collections/:id/nodes` | Nodes in collection |
| POST | `/api/collections` | Create collection |
| PUT | `/api/collections/:id` | Update collection |
| DELETE | `/api/collections/:id` | Delete collection |

### 5.6 Indexing & Queries

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/index` | Index file or directory |
| GET | `/api/query/nodes/by-date` | Query by date range |
| GET | `/api/query/nodes/by-type` | Query by MIME type |
| GET | `/api/query/nodes/by-location` | Query by path prefix |

---

## 6. Key Components

### 6.1 Frontend

| Component | Purpose |
|-----------|---------|
| `Layout.jsx` | Main wrapper, global state, toolbar, sidebar |
| `FileListTable` | Reusable sortable table with multi-select |
| `DetailPanel` | Right sidebar for file details and actions |
| `ImportConfirmModal` | File import confirmation with options |
| `CreateCollectionModal` | New collection form |
| `ColorPickerModal` | Collection color selector |
| `ContextMenu` | Right-click menus |

### 6.2 Pages

| Page | Route | Purpose |
|------|-------|---------|
| FilesView | `/` | All indexed files |
| TagsView | `/tags` | Files grouped by tags |
| CollectionsView | `/collections` | Collection list |
| CollectionDetailView | `/collections/:id` | Single collection |
| GraphView | `/graph` | Force-directed graph |
| DevView | `/dev` | Debug tools |

### 6.3 Backend Services

| Service | Purpose |
|---------|---------|
| `database-manager.js` | Lifecycle management, port allocation |
| `db-service.js` | SurrealDB wrapper, CRUD operations |
| `server.js` | Express API, route definitions |
| `fs-indexer` | File scanning, hashing, metadata |
| `force-sim` | D3 physics simulation wrapper |

---

## 7. Data Flows

### 7.1 File Indexing Flow

```
User clicks "Add Files"
    ↓
Electron IPC → Native file dialog
    ↓
ImportConfirmModal (select tags, collection)
    ↓
POST /api/index {path}
    ↓
fs-indexer: recurse, hash, extract metadata
    ↓
POST /api/nodes for each file
    ↓
Database: create/update records
    ↓
Frontend: reload and display
```

### 7.2 Collection Query Flow

```
User clicks collection
    ↓
GET /api/collections/:id
    ↓
GET /api/collections/:id/nodes
    ↓
Filter: nodes with ALL required tags (AND)
    ↓
Return filtered results
    ↓
Render in FileListTable
```

---

## 8. Keyboard Shortcuts

| Shortcut | Action |
|----------|--------|
| Cmd/Ctrl+A | Select all files |
| Delete/Backspace | Delete selected files |
| Cmd/Ctrl+Click | Toggle selection |
| Shift+Click | Range select |
| Cmd/Ctrl+R | Reload window (dev) |

---

## 9. Technical Constraints

### 9.1 Performance
- Graph visualization degrades beyond ~1000 nodes
- File watching impacts performance with large directories

### 9.2 Security
- Context isolation enabled in Electron
- No nodeIntegration in renderer
- Preload script with explicit API surface

### 9.3 Limitations
- Single-user, local-only (no cloud sync)
- No real-time collaboration
- File watching requires OS permissions

---

## 10. Lessons Learned (for v0.3)

### 10.1 Architecture Considerations

1. **State Management:** Currently in `Layout.jsx` - consider dedicated state solution (Zustand, Jotai) for better separation
2. **Collection Logic:** AND queries handled client-side - could move to database for performance
3. **Pinned Collections:** Uses localStorage + custom events - could unify with app state
4. **Service Communication:** Consider WebSocket for real-time updates instead of polling

### 10.2 Feature Gaps

1. No OR logic for collections (only AND)
2. No bulk tag operations
3. No file preview (images, PDFs)
4. No search within file contents
5. No export/backup functionality

### 10.3 Technical Debt

1. Graph performance optimization needed
2. Error handling could be more robust
3. No offline queue for operations
4. Limited test coverage

---

## 11. Build & Development

### 11.1 Development Commands

```bash
npm run dev              # Start database + frontend
npm run electron:dev     # Start Electron with dev server
```

### 11.2 Build Commands

```bash
npm run build           # Build frontend + Electron
npm run package:mac     # macOS DMG/zip
npm run package:win     # Windows NSIS/portable
npm run package:linux   # AppImage/deb
```

### 11.3 Workspaces

- `@index/frontend` - React application
- `@index/database` - Express + SurrealDB
- `@index/fs-indexer` - File scanner
- `@index/force-sim` - Graph physics

---

*Specification generated: January 2026*
*Based on codebase commit: a109580 (UI update)*
